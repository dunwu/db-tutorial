---
title: SQL è¯­æ³•é«˜çº§ç‰¹æ€§
date: 2022-04-27 22:13:55
categories:
  - æ•°æ®åº“
  - å…³ç³»å‹æ•°æ®åº“
  - ç»¼åˆ
tags:
  - æ•°æ®åº“
  - å…³ç³»å‹æ•°æ®åº“
  - SQL
permalink: /pages/1ae1ca/
---

# SQL è¯­æ³•é«˜çº§ç‰¹æ€§

> æœ¬æ–‡é’ˆå¯¹å…³ç³»å‹æ•°æ®åº“çš„åŸºæœ¬è¯­æ³•ã€‚é™äºç¯‡å¹…ï¼Œæœ¬æ–‡ä¾§é‡è¯´æ˜ç”¨æ³•ï¼Œä¸ä¼šå±•å¼€è®²è§£ç‰¹æ€§ã€åŸç†ã€‚
>
> æœ¬æ–‡è¯­æ³•ä¸»è¦é’ˆå¯¹ Mysqlï¼Œä½†å¤§éƒ¨åˆ†çš„è¯­æ³•å¯¹å…¶ä»–å…³ç³»å‹æ•°æ®åº“ä¹Ÿé€‚ç”¨ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/dev/snap/20200115160512.png)

## è¿æ¥å’Œç»„åˆ

### è¿æ¥ï¼ˆJOINï¼‰

> è¿æ¥ç”¨äºè¿æ¥å¤šä¸ªè¡¨ï¼Œä½¿ç”¨ `JOIN` å…³é”®å­—ï¼Œå¹¶ä¸”æ¡ä»¶è¯­å¥ä½¿ç”¨ `ON` è€Œä¸æ˜¯ `WHERE`ã€‚

å¦‚æœä¸€ä¸ª `JOIN` è‡³å°‘æœ‰ä¸€ä¸ªå…¬å…±å­—æ®µå¹¶ä¸”å®ƒä»¬ä¹‹é—´å­˜åœ¨å…³ç³»ï¼Œåˆ™è¯¥ `JOIN` å¯ä»¥åœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªè¡¨ä¸Šå·¥ä½œã€‚

`JOIN` ä¿æŒåŸºè¡¨ï¼ˆç»“æ„å’Œæ•°æ®ï¼‰ä¸å˜ã€‚**è¿æ¥å¯ä»¥æ›¿æ¢å­æŸ¥è¯¢ï¼Œå¹¶ä¸”æ¯”å­æŸ¥è¯¢çš„æ•ˆç‡ä¸€èˆ¬ä¼šæ›´å¿«**ã€‚

`JOIN` æœ‰ä¸¤ç§è¿æ¥ç±»å‹ï¼šå†…è¿æ¥å’Œå¤–è¿æ¥ã€‚

<div align="center">
  <img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/database/mysql/sql-join.png" alt="sql-join">
</div>

#### å†…è¿æ¥ï¼ˆINNER JOINï¼‰

å†…è¿æ¥åˆç§°ç­‰å€¼è¿æ¥ï¼Œ**ä½¿ç”¨ `INNER JOIN` å…³é”®å­—**ã€‚åœ¨æ²¡æœ‰æ¡ä»¶è¯­å¥çš„æƒ…å†µä¸‹**è¿”å›ç¬›å¡å°”ç§¯**ã€‚

```sql
SELECT vend_name, prod_name, prod_price
FROM vendors INNER JOIN products
ON vendors.vend_id = products.vend_id;
```

##### è‡ªè¿æ¥ï¼ˆ`=`ï¼‰

è‡ªè¿æ¥å¯ä»¥çœ‹æˆå†…è¿æ¥çš„ä¸€ç§ï¼Œåªæ˜¯**è¿æ¥çš„è¡¨æ˜¯è‡ªèº«**è€Œå·²ã€‚**è‡ªç„¶è¿æ¥æ˜¯æŠŠåŒååˆ—é€šè¿‡ `=` è¿æ¥èµ·æ¥**çš„ï¼ŒåŒååˆ—å¯ä»¥æœ‰å¤šä¸ªã€‚

```sql
SELECT c1.cust_id, c1.cust_name, c1.cust_contact
FROM customers c1, customers c2
WHERE c1.cust_name = c2.cust_name
AND c2.cust_contact = 'Jim Jones';
```

##### è‡ªç„¶è¿æ¥ï¼ˆNATURAL JOINï¼‰

å†…è¿æ¥æä¾›è¿æ¥çš„åˆ—ï¼Œè€Œè‡ªç„¶è¿æ¥**è‡ªåŠ¨è¿æ¥æ‰€æœ‰åŒååˆ—**ã€‚è‡ªç„¶è¿æ¥ä½¿ç”¨ `NATURAL JOIN` å…³é”®å­—ã€‚

```sql
SELECT *
FROM Products
NATURAL JOIN Customers;
```

#### å¤–è¿æ¥ï¼ˆOUTER JOINï¼‰

å¤–è¿æ¥è¿”å›ä¸€ä¸ªè¡¨ä¸­çš„æ‰€æœ‰è¡Œï¼Œå¹¶ä¸”ä»…è¿”å›æ¥è‡ªæ­¤è¡¨ä¸­æ»¡è¶³è¿æ¥æ¡ä»¶çš„é‚£äº›è¡Œï¼Œå³ä¸¤ä¸ªè¡¨ä¸­çš„åˆ—æ˜¯ç›¸ç­‰çš„ã€‚å¤–è¿æ¥åˆ†ä¸ºå·¦å¤–è¿æ¥ã€å³å¤–è¿æ¥ã€å…¨å¤–è¿æ¥ï¼ˆMysql ä¸æ”¯æŒï¼‰ã€‚

##### å·¦è¿æ¥ï¼ˆLEFT JOINï¼‰

å·¦å¤–è¿æ¥å°±æ˜¯ä¿ç•™å·¦è¡¨æ²¡æœ‰å…³è”çš„è¡Œã€‚

```sql
SELECT customers.cust_id, orders.order_num
FROM customers LEFT JOIN orders
ON customers.cust_id = orders.cust_id;
```

##### å³è¿æ¥ï¼ˆRIGHT JOINï¼‰

å³å¤–è¿æ¥å°±æ˜¯ä¿ç•™å³è¡¨æ²¡æœ‰å…³è”çš„è¡Œã€‚

```sql
SELECT customers.cust_id, orders.order_num
FROM customers RIGHT JOIN orders
ON customers.cust_id = orders.cust_id;
```

### ç»„åˆï¼ˆUNIONï¼‰

> `UNION` è¿ç®—ç¬¦**å°†ä¸¤ä¸ªæˆ–æ›´å¤šæŸ¥è¯¢çš„ç»“æœç»„åˆèµ·æ¥ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªç»“æœé›†**ï¼Œå…¶ä¸­åŒ…å«æ¥è‡ª `UNION` ä¸­å‚ä¸æŸ¥è¯¢çš„æå–è¡Œã€‚

`UNION` åŸºæœ¬è§„åˆ™ï¼š

- æ‰€æœ‰æŸ¥è¯¢çš„åˆ—æ•°å’Œåˆ—é¡ºåºå¿…é¡»ç›¸åŒã€‚
- æ¯ä¸ªæŸ¥è¯¢ä¸­æ¶‰åŠè¡¨çš„åˆ—çš„æ•°æ®ç±»å‹å¿…é¡»ç›¸åŒæˆ–å…¼å®¹ã€‚
- é€šå¸¸è¿”å›çš„åˆ—åå–è‡ªç¬¬ä¸€ä¸ªæŸ¥è¯¢ã€‚

é»˜è®¤ä¼šå»é™¤ç›¸åŒè¡Œï¼Œå¦‚æœéœ€è¦ä¿ç•™ç›¸åŒè¡Œï¼Œä½¿ç”¨ `UNION ALL`ã€‚

åªèƒ½åŒ…å«ä¸€ä¸ª `ORDER BY` å­å¥ï¼Œå¹¶ä¸”å¿…é¡»ä½äºè¯­å¥çš„æœ€åã€‚

åº”ç”¨åœºæ™¯ï¼š

- åœ¨ä¸€ä¸ªæŸ¥è¯¢ä¸­ä»ä¸åŒçš„è¡¨è¿”å›ç»“æ„æ•°æ®ã€‚
- å¯¹ä¸€ä¸ªè¡¨æ‰§è¡Œå¤šä¸ªæŸ¥è¯¢ï¼ŒæŒ‰ä¸€ä¸ªæŸ¥è¯¢è¿”å›æ•°æ®ã€‚

ç»„åˆæŸ¥è¯¢ç¤ºä¾‹ï¼š

```sql
SELECT cust_name, cust_contact, cust_email
FROM customers
WHERE cust_state IN ('IL', 'IN', 'MI')
UNION
SELECT cust_name, cust_contact, cust_email
FROM customers
WHERE cust_name = 'Fun4All';
```

### JOIN vs UNION

- `JOIN` ä¸­è¿æ¥è¡¨çš„åˆ—å¯èƒ½ä¸åŒï¼Œä½†åœ¨ `UNION` ä¸­ï¼Œæ‰€æœ‰æŸ¥è¯¢çš„åˆ—æ•°å’Œåˆ—é¡ºåºå¿…é¡»ç›¸åŒã€‚
- `UNION` å°†æŸ¥è¯¢ä¹‹åçš„è¡Œæ”¾åœ¨ä¸€èµ·ï¼ˆå‚ç›´æ”¾ç½®ï¼‰ï¼Œä½† `JOIN` å°†æŸ¥è¯¢ä¹‹åçš„åˆ—æ”¾åœ¨ä¸€èµ·ï¼ˆæ°´å¹³æ”¾ç½®ï¼‰ï¼Œå³å®ƒæ„æˆä¸€ä¸ªç¬›å¡å°”ç§¯ã€‚

## å‡½æ•°

> ğŸ”” æ³¨æ„ï¼šä¸åŒæ•°æ®åº“çš„å‡½æ•°å¾€å¾€å„ä¸ç›¸åŒï¼Œå› æ­¤ä¸å¯ç§»æ¤ã€‚æœ¬èŠ‚ä¸»è¦ä»¥ Mysql çš„å‡½æ•°ä¸ºä¾‹ã€‚

### æ–‡æœ¬å¤„ç†

|         å‡½æ•°         |          è¯´æ˜          |
| :------------------: | :--------------------: |
| `LEFT()`ã€`RIGHT()`  |   å·¦è¾¹æˆ–è€…å³è¾¹çš„å­—ç¬¦   |
| `LOWER()`ã€`UPPER()` |   è½¬æ¢ä¸ºå°å†™æˆ–è€…å¤§å†™   |
| `LTRIM()`ã€`RTIM()`  | å»é™¤å·¦è¾¹æˆ–è€…å³è¾¹çš„ç©ºæ ¼ |
|      `LENGTH()`      |          é•¿åº¦          |
|     `SOUNDEX()`      |      è½¬æ¢ä¸ºè¯­éŸ³å€¼      |

å…¶ä¸­ï¼Œ **SOUNDEX()** å¯ä»¥å°†ä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢ä¸ºæè¿°å…¶è¯­éŸ³è¡¨ç¤ºçš„å­—æ¯æ•°å­—æ¨¡å¼ã€‚

```sql
SELECT *
FROM mytable
WHERE SOUNDEX(col1) = SOUNDEX('apple')
```

### æ—¥æœŸå’Œæ—¶é—´å¤„ç†

- æ—¥æœŸæ ¼å¼ï¼š`YYYY-MM-DD`
- æ—¶é—´æ ¼å¼ï¼š`HH:MM:SS`

|      å‡½ æ•°      |             è¯´ æ˜              |
| :-------------: | :----------------------------: |
|   `AddDate()`   |    å¢åŠ ä¸€ä¸ªæ—¥æœŸï¼ˆå¤©ã€å‘¨ç­‰ï¼‰    |
|   `AddTime()`   |    å¢åŠ ä¸€ä¸ªæ—¶é—´ï¼ˆæ—¶ã€åˆ†ç­‰ï¼‰    |
|   `CurDate()`   |          è¿”å›å½“å‰æ—¥æœŸ          |
|   `CurTime()`   |          è¿”å›å½“å‰æ—¶é—´          |
|    `Date()`     |     è¿”å›æ—¥æœŸæ—¶é—´çš„æ—¥æœŸéƒ¨åˆ†     |
|  `DateDiff()`   |        è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹å·®        |
|  `Date_Add()`   |     é«˜åº¦çµæ´»çš„æ—¥æœŸè¿ç®—å‡½æ•°     |
| `Date_Format()` |  è¿”å›ä¸€ä¸ªæ ¼å¼åŒ–çš„æ—¥æœŸæˆ–æ—¶é—´ä¸²  |
|     `Day()`     |     è¿”å›ä¸€ä¸ªæ—¥æœŸçš„å¤©æ•°éƒ¨åˆ†     |
|  `DayOfWeek()`  | å¯¹äºä¸€ä¸ªæ—¥æœŸï¼Œè¿”å›å¯¹åº”çš„æ˜ŸæœŸå‡  |
|    `Hour()`     |     è¿”å›ä¸€ä¸ªæ—¶é—´çš„å°æ—¶éƒ¨åˆ†     |
|   `Minute()`    |     è¿”å›ä¸€ä¸ªæ—¶é—´çš„åˆ†é’Ÿéƒ¨åˆ†     |
|    `Month()`    |     è¿”å›ä¸€ä¸ªæ—¥æœŸçš„æœˆä»½éƒ¨åˆ†     |
|     `Now()`     |       è¿”å›å½“å‰æ—¥æœŸå’Œæ—¶é—´       |
|   `Second()`    |      è¿”å›ä¸€ä¸ªæ—¶é—´çš„ç§’éƒ¨åˆ†      |
|    `Time()`     |   è¿”å›ä¸€ä¸ªæ—¥æœŸæ—¶é—´çš„æ—¶é—´éƒ¨åˆ†   |
|    `Year()`     |     è¿”å›ä¸€ä¸ªæ—¥æœŸçš„å¹´ä»½éƒ¨åˆ†     |

```sql
mysql> SELECT NOW();
```

```
2018-4-14 20:25:11
```

### æ•°å€¼å¤„ç†

|  å‡½æ•°  |  è¯´æ˜  |
| :----: | :----: |
| SIN()  |  æ­£å¼¦  |
| COS()  |  ä½™å¼¦  |
| TAN()  |  æ­£åˆ‡  |
| ABS()  | ç»å¯¹å€¼ |
| SQRT() | å¹³æ–¹æ ¹ |
| MOD()  |  ä½™æ•°  |
| EXP()  |  æŒ‡æ•°  |
|  PI()  | åœ†å‘¨ç‡ |
| RAND() | éšæœºæ•° |

### æ±‡æ€»

|   å‡½ æ•°   |      è¯´ æ˜       |
| :-------: | :--------------: |
|  `AVG()`  | è¿”å›æŸåˆ—çš„å¹³å‡å€¼ |
| `COUNT()` |  è¿”å›æŸåˆ—çš„è¡Œæ•°  |
|  `MAX()`  | è¿”å›æŸåˆ—çš„æœ€å¤§å€¼ |
|  `MIN()`  | è¿”å›æŸåˆ—çš„æœ€å°å€¼ |
|  `SUM()`  |  è¿”å›æŸåˆ—å€¼ä¹‹å’Œ  |

`AVG()` ä¼šå¿½ç•¥ NULL è¡Œã€‚

ä½¿ç”¨ DISTINCT å¯ä»¥è®©æ±‡æ€»å‡½æ•°å€¼æ±‡æ€»ä¸åŒçš„å€¼ã€‚

```sql
SELECT AVG(DISTINCT col1) AS avg_col
FROM mytable
```

## åˆ†ç»„

### GROUP BY

> `GROUP BY` å­å¥å°†è®°å½•åˆ†ç»„åˆ°æ±‡æ€»è¡Œä¸­ï¼Œ`GROUP BY` ä¸ºæ¯ä¸ªç»„è¿”å›ä¸€ä¸ªè®°å½•ã€‚

`GROUP BY` å¯ä»¥æŒ‰ä¸€åˆ—æˆ–å¤šåˆ—è¿›è¡Œåˆ†ç»„ã€‚

`GROUP BY` é€šå¸¸è¿˜æ¶‰åŠèšåˆå‡½æ•°ï¼šCOUNTï¼ŒMAXï¼ŒSUMï¼ŒAVG ç­‰ã€‚

`GROUP BY` æŒ‰åˆ†ç»„å­—æ®µè¿›è¡Œæ’åºåï¼Œ`ORDER BY` å¯ä»¥ä»¥æ±‡æ€»å­—æ®µæ¥è¿›è¡Œæ’åºã€‚

åˆ†ç»„ç¤ºä¾‹ï¼š

```sql
SELECT cust_name, COUNT(cust_address) AS addr_num
FROM Customers GROUP BY cust_name;
```

åˆ†ç»„åæ’åºç¤ºä¾‹ï¼š

```sql
SELECT cust_name, COUNT(cust_address) AS addr_num
FROM Customers GROUP BY cust_name
ORDER BY cust_name DESC;
```

### HAVING

> `HAVING` ç”¨äºå¯¹æ±‡æ€»çš„ `GROUP BY` ç»“æœè¿›è¡Œè¿‡æ»¤ã€‚`HAVING` è¦æ±‚å­˜åœ¨ä¸€ä¸ª `GROUP BY` å­å¥ã€‚

`WHERE` å’Œ `HAVING` å¯ä»¥åœ¨ç›¸åŒçš„æŸ¥è¯¢ä¸­ã€‚

`HAVING` vs `WHERE`ï¼š

- `WHERE` å’Œ `HAVING` éƒ½æ˜¯ç”¨äºè¿‡æ»¤ã€‚
- `HAVING` é€‚ç”¨äºæ±‡æ€»çš„ç»„è®°å½•ï¼›è€Œ `WHERE` é€‚ç”¨äºå•ä¸ªè®°å½•ã€‚

ä½¿ç”¨ `WHERE` å’Œ `HAVING` è¿‡æ»¤æ•°æ®ç¤ºä¾‹ï¼š

```sql
SELECT cust_name, COUNT(*) AS num
FROM Customers
WHERE cust_email IS NOT NULL
GROUP BY cust_name
HAVING COUNT(*) >= 1;
```

---

**ï¼ˆä»¥ä¸‹ä¸º DDL è¯­å¥ç”¨æ³•ï¼‰**

## äº‹åŠ¡

ä¸èƒ½å›é€€ `SELECT` è¯­å¥ï¼Œå›é€€ `SELECT` è¯­å¥ä¹Ÿæ²¡æ„ä¹‰ï¼›ä¹Ÿä¸èƒ½å›é€€ `CREATE` å’Œ `DROP` è¯­å¥ã€‚

**MySQL é»˜è®¤é‡‡ç”¨éšå¼æäº¤ç­–ç•¥ï¼ˆ`autocommit`ï¼‰**ï¼Œæ¯æ‰§è¡Œä¸€æ¡è¯­å¥å°±æŠŠè¿™æ¡è¯­å¥å½“æˆä¸€ä¸ªäº‹åŠ¡ç„¶åè¿›è¡Œæäº¤ã€‚å½“å‡ºç° `START TRANSACTION` è¯­å¥æ—¶ï¼Œä¼šå…³é—­éšå¼æäº¤ï¼›å½“ `COMMIT` æˆ– `ROLLBACK` è¯­å¥æ‰§è¡Œåï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨å…³é—­ï¼Œé‡æ–°æ¢å¤éšå¼æäº¤ã€‚

é€šè¿‡ `set autocommit=0` å¯ä»¥å–æ¶ˆè‡ªåŠ¨æäº¤ï¼Œç›´åˆ° `set autocommit=1` æ‰ä¼šæäº¤ï¼›`autocommit` æ ‡è®°æ˜¯é’ˆå¯¹æ¯ä¸ªè¿æ¥è€Œä¸æ˜¯é’ˆå¯¹æœåŠ¡å™¨çš„ã€‚

äº‹åŠ¡å¤„ç†æŒ‡ä»¤ï¼š

- `START TRANSACTION` - æŒ‡ä»¤ç”¨äºæ ‡è®°äº‹åŠ¡çš„èµ·å§‹ç‚¹ã€‚
- `SAVEPOINT` - æŒ‡ä»¤ç”¨äºåˆ›å»ºä¿ç•™ç‚¹ã€‚
- `ROLLBACK TO` - æŒ‡ä»¤ç”¨äºå›æ»šåˆ°æŒ‡å®šçš„ä¿ç•™ç‚¹ï¼›å¦‚æœæ²¡æœ‰è®¾ç½®ä¿ç•™ç‚¹ï¼Œåˆ™å›é€€åˆ° `START TRANSACTION` è¯­å¥å¤„ã€‚
- `COMMIT` - æäº¤äº‹åŠ¡ã€‚
- `RELEASE SAVEPOINT`ï¼šåˆ é™¤æŸä¸ªä¿å­˜ç‚¹ã€‚
- `SET TRANSACTION`ï¼šè®¾ç½®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ã€‚

äº‹åŠ¡å¤„ç†ç¤ºä¾‹ï¼š

```sql
-- å¼€å§‹äº‹åŠ¡
START TRANSACTION;

-- æ’å…¥æ“ä½œ A
INSERT INTO `user`
VALUES (1, 'root1', 'root1', 'xxxx@163.com');

-- åˆ›å»ºä¿ç•™ç‚¹ updateA
SAVEPOINT updateA;

-- æ’å…¥æ“ä½œ B
INSERT INTO `user`
VALUES (2, 'root2', 'root2', 'xxxx@163.com');

-- å›æ»šåˆ°ä¿ç•™ç‚¹ updateA
ROLLBACK TO updateA;

-- æäº¤äº‹åŠ¡ï¼Œåªæœ‰æ“ä½œ A ç”Ÿæ•ˆ
COMMIT;
```

### ACID

### äº‹åŠ¡éš”ç¦»çº§åˆ«

---

**ï¼ˆä»¥ä¸‹ä¸º DCL è¯­å¥ç”¨æ³•ï¼‰**

## æƒé™æ§åˆ¶

`GRANT` å’Œ `REVOKE` å¯åœ¨å‡ ä¸ªå±‚æ¬¡ä¸Šæ§åˆ¶è®¿é—®æƒé™ï¼š

- æ•´ä¸ªæœåŠ¡å™¨ï¼Œä½¿ç”¨ `GRANT ALL` å’Œ `REVOKE ALL`ï¼›
- æ•´ä¸ªæ•°æ®åº“ï¼Œä½¿ç”¨ ON database.\*ï¼›
- ç‰¹å®šçš„è¡¨ï¼Œä½¿ç”¨ ON database.tableï¼›
- ç‰¹å®šçš„åˆ—ï¼›
- ç‰¹å®šçš„å­˜å‚¨è¿‡ç¨‹ã€‚

æ–°åˆ›å»ºçš„è´¦æˆ·æ²¡æœ‰ä»»ä½•æƒé™ã€‚

è´¦æˆ·ç”¨ `username@host` çš„å½¢å¼å®šä¹‰ï¼Œ`username@%` ä½¿ç”¨çš„æ˜¯é»˜è®¤ä¸»æœºåã€‚

MySQL çš„è´¦æˆ·ä¿¡æ¯ä¿å­˜åœ¨ mysql è¿™ä¸ªæ•°æ®åº“ä¸­ã€‚

```sql
USE mysql;
SELECT user FROM user;
```

### åˆ›å»ºè´¦æˆ·

```sql
CREATE USER myuser IDENTIFIED BY 'mypassword';
```

### ä¿®æ”¹è´¦æˆ·å

```sql
UPDATE user SET user='newuser' WHERE user='myuser';
FLUSH PRIVILEGES;
```

### åˆ é™¤è´¦æˆ·

```sql
DROP USER myuser;
```

### æŸ¥çœ‹æƒé™

```sql
SHOW GRANTS FOR myuser;
```

### æˆäºˆæƒé™

```sql
GRANT SELECT, INSERT ON *.* TO myuser;
```

### åˆ é™¤æƒé™

```sql
REVOKE SELECT, INSERT ON *.* FROM myuser;
```

### æ›´æ”¹å¯†ç 

```sql
SET PASSWORD FOR myuser = 'mypass';
```

## å­˜å‚¨è¿‡ç¨‹

å­˜å‚¨è¿‡ç¨‹çš„è‹±æ–‡æ˜¯ Stored Procedureã€‚å®ƒå¯ä»¥è§†ä¸ºä¸€ç»„ SQL è¯­å¥çš„æ‰¹å¤„ç†ã€‚ä¸€æ—¦å­˜å‚¨è¿‡ç¨‹è¢«åˆ›å»ºå‡ºæ¥ï¼Œä½¿ç”¨å®ƒå°±åƒä½¿ç”¨å‡½æ•°ä¸€æ ·ç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥é€šè¿‡è°ƒç”¨å­˜å‚¨è¿‡ç¨‹åå³å¯ã€‚

å®šä¹‰å­˜å‚¨è¿‡ç¨‹çš„è¯­æ³•æ ¼å¼ï¼š

```sql
CREATE PROCEDURE å­˜å‚¨è¿‡ç¨‹åç§° ([å‚æ•°åˆ—è¡¨])
BEGIN
    éœ€è¦æ‰§è¡Œçš„è¯­å¥
END
```

å­˜å‚¨è¿‡ç¨‹å®šä¹‰è¯­å¥ç±»å‹ï¼š

- `CREATE PROCEDURE` ç”¨äºåˆ›å»ºå­˜å‚¨è¿‡ç¨‹
- `DROP PROCEDURE` ç”¨äºåˆ é™¤å­˜å‚¨è¿‡ç¨‹
- `ALTER PROCEDURE` ç”¨äºä¿®æ”¹å­˜å‚¨è¿‡ç¨‹

### ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹

åˆ›å»ºå­˜å‚¨è¿‡ç¨‹çš„è¦ç‚¹ï¼š

- `DELIMITER` ç”¨äºå®šä¹‰è¯­å¥çš„ç»“æŸç¬¦
- å­˜å‚¨è¿‡ç¨‹çš„ 3 ç§å‚æ•°ç±»å‹ï¼š
  - `IN`ï¼šå­˜å‚¨è¿‡ç¨‹çš„å…¥å‚
  - `OUT`ï¼šå­˜å‚¨è¿‡ç¨‹çš„å‡ºå‚
  - `INPUT`ï¼šæ—¢æ˜¯å­˜å‚¨è¿‡ç¨‹çš„å…¥å‚ï¼Œä¹Ÿæ˜¯å­˜å‚¨è¿‡ç¨‹çš„å‡ºå‚
- æµæ§åˆ¶è¯­å¥ï¼š
  - `BEGINâ€¦END`ï¼š`BEGINâ€¦END` ä¸­é—´åŒ…å«äº†å¤šä¸ªè¯­å¥ï¼Œæ¯ä¸ªè¯­å¥éƒ½ä»¥ï¼ˆ`;`ï¼‰å·ä¸ºç»“æŸç¬¦ã€‚
  - `DECLARE`ï¼š`DECLARE` ç”¨æ¥å£°æ˜å˜é‡ï¼Œä½¿ç”¨çš„ä½ç½®åœ¨äº `BEGINâ€¦END` è¯­å¥ä¸­é—´ï¼Œè€Œä¸”éœ€è¦åœ¨å…¶ä»–è¯­å¥ä½¿ç”¨ä¹‹å‰è¿›è¡Œå˜é‡çš„å£°æ˜ã€‚
  - `SET`ï¼šèµ‹å€¼è¯­å¥ï¼Œç”¨äºå¯¹å˜é‡è¿›è¡Œèµ‹å€¼ã€‚
  - `SELECTâ€¦INTO`ï¼šæŠŠä»æ•°æ®è¡¨ä¸­æŸ¥è¯¢çš„ç»“æœå­˜æ”¾åˆ°å˜é‡ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸ºå˜é‡èµ‹å€¼ã€‚æ¯æ¬¡åªèƒ½ç»™ä¸€ä¸ªå˜é‡èµ‹å€¼ï¼Œä¸æ”¯æŒé›†åˆçš„æ“ä½œã€‚
  - `IFâ€¦THENâ€¦ENDIF`ï¼šæ¡ä»¶åˆ¤æ–­è¯­å¥ï¼Œå¯ä»¥åœ¨ `IFâ€¦THENâ€¦ENDIF` ä¸­ä½¿ç”¨ `ELSE` å’Œ `ELSEIF` æ¥è¿›è¡Œæ¡ä»¶åˆ¤æ–­ã€‚
  - `CASE`ï¼š`CASE` è¯­å¥ç”¨äºå¤šæ¡ä»¶çš„åˆ†æ”¯åˆ¤æ–­ã€‚

åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ç¤ºä¾‹ï¼š

```sql
DROP PROCEDURE IF EXISTS `proc_adder`;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `proc_adder`(IN a int, IN b int, OUT sum int)
BEGIN
    DECLARE c int;
    if a is null then set a = 0;
    end if;

    if b is null then set b = 0;
    end if;

    set sum  = a + b;
END
;;
DELIMITER ;
```

ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ç¤ºä¾‹ï¼š

```sql
set @b=5;
call proc_adder(2,@b,@s);
select @s as sum;
```

### å­˜å‚¨è¿‡ç¨‹çš„åˆ©å¼Š

å­˜å‚¨è¿‡ç¨‹çš„ä¼˜ç‚¹ï¼š

- **æ‰§è¡Œæ•ˆç‡é«˜**ï¼šä¸€æ¬¡ç¼–è¯‘å¤šæ¬¡ä½¿ç”¨ã€‚
- **å®‰å…¨æ€§å¼º**ï¼šåœ¨è®¾å®šå­˜å‚¨è¿‡ç¨‹çš„æ—¶å€™å¯ä»¥è®¾ç½®å¯¹ç”¨æˆ·çš„ä½¿ç”¨æƒé™ï¼Œè¿™æ ·å°±å’Œè§†å›¾ä¸€æ ·å…·æœ‰è¾ƒå¼ºçš„å®‰å…¨æ€§ã€‚
- **å¯å¤ç”¨**ï¼šå°†ä»£ç å°è£…ï¼Œå¯ä»¥æé«˜ä»£ç å¤ç”¨ã€‚
- **æ€§èƒ½å¥½**
  - ç”±äºæ˜¯é¢„å…ˆç¼–è¯‘ï¼Œå› æ­¤å…·æœ‰å¾ˆé«˜çš„æ€§èƒ½ã€‚
  - ä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹æ›¿ä»£å¤§é‡ T_SQL è¯­å¥ ï¼Œå¯ä»¥é™ä½ç½‘ç»œé€šä¿¡é‡ï¼Œæé«˜é€šä¿¡é€Ÿç‡ã€‚

å­˜å‚¨è¿‡ç¨‹çš„ç¼ºç‚¹ï¼š

- **å¯ç§»æ¤æ€§å·®**ï¼šå­˜å‚¨è¿‡ç¨‹ä¸èƒ½è·¨æ•°æ®åº“ç§»æ¤ã€‚ç”±äºä¸åŒæ•°æ®åº“çš„å­˜å‚¨è¿‡ç¨‹è¯­æ³•å‡ ä¹éƒ½ä¸ä¸€æ ·ï¼Œååˆ†éš¾ä»¥ç»´æŠ¤ï¼ˆä¸é€šç”¨ï¼‰ã€‚
- **è°ƒè¯•å›°éš¾**ï¼šåªæœ‰å°‘æ•° DBMS æ”¯æŒå­˜å‚¨è¿‡ç¨‹çš„è°ƒè¯•ã€‚å¯¹äºå¤æ‚çš„å­˜å‚¨è¿‡ç¨‹æ¥è¯´ï¼Œå¼€å‘å’Œç»´æŠ¤éƒ½ä¸å®¹æ˜“ã€‚
- **ç‰ˆæœ¬ç®¡ç†å›°éš¾**ï¼šæ¯”å¦‚æ•°æ®è¡¨ç´¢å¼•å‘ç”Ÿå˜åŒ–äº†ï¼Œå¯èƒ½ä¼šå¯¼è‡´å­˜å‚¨è¿‡ç¨‹å¤±æ•ˆã€‚æˆ‘ä»¬åœ¨å¼€å‘è½¯ä»¶çš„æ—¶å€™å¾€å¾€éœ€è¦è¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œä½†æ˜¯å­˜å‚¨è¿‡ç¨‹æœ¬èº«æ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶ï¼Œç‰ˆæœ¬è¿­ä»£æ›´æ–°çš„æ—¶å€™å¾ˆéº»çƒ¦ã€‚
- **ä¸é€‚åˆé«˜å¹¶å‘çš„åœºæ™¯**ï¼šé«˜å¹¶å‘çš„åœºæ™¯éœ€è¦å‡å°‘æ•°æ®åº“çš„å‹åŠ›ï¼Œæœ‰æ—¶æ•°æ®åº“ä¼šé‡‡ç”¨åˆ†åº“åˆ†è¡¨çš„æ–¹å¼ï¼Œè€Œä¸”å¯¹å¯æ‰©å±•æ€§è¦æ±‚å¾ˆé«˜ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå­˜å‚¨è¿‡ç¨‹ä¼šå˜å¾—éš¾ä»¥ç»´æŠ¤ï¼Œå¢åŠ æ•°æ®åº“çš„å‹åŠ›ï¼Œæ˜¾ç„¶å°±ä¸é€‚ç”¨äº†ã€‚

> _ç»¼ä¸Šï¼Œå­˜å‚¨è¿‡ç¨‹çš„ä¼˜ç¼ºç‚¹éƒ½éå¸¸çªå‡ºï¼Œæ˜¯å¦ä½¿ç”¨ä¸€å®šè¦æ…é‡ï¼Œéœ€è¦æ ¹æ®å…·ä½“åº”ç”¨åœºæ™¯æ¥æƒè¡¡_ã€‚

### è§¦å‘å™¨

> è§¦å‘å™¨å¯ä»¥è§†ä¸ºä¸€ç§ç‰¹æ®Šçš„å­˜å‚¨è¿‡ç¨‹ã€‚
>
> è§¦å‘å™¨æ˜¯ä¸€ç§ä¸è¡¨æ“ä½œæœ‰å…³çš„æ•°æ®åº“å¯¹è±¡ï¼Œå½“è§¦å‘å™¨æ‰€åœ¨è¡¨ä¸Šå‡ºç°æŒ‡å®šäº‹ä»¶æ—¶ï¼Œå°†è°ƒç”¨è¯¥å¯¹è±¡ï¼Œå³è¡¨çš„æ“ä½œäº‹ä»¶è§¦å‘è¡¨ä¸Šçš„è§¦å‘å™¨çš„æ‰§è¡Œã€‚

#### è§¦å‘å™¨ç‰¹æ€§

å¯ä»¥ä½¿ç”¨è§¦å‘å™¨æ¥è¿›è¡Œå®¡è®¡è·Ÿè¸ªï¼ŒæŠŠä¿®æ”¹è®°å½•åˆ°å¦å¤–ä¸€å¼ è¡¨ä¸­ã€‚

MySQL ä¸å…è®¸åœ¨è§¦å‘å™¨ä¸­ä½¿ç”¨ `CALL` è¯­å¥ ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ã€‚

**`BEGIN` å’Œ `END`**

å½“è§¦å‘å™¨çš„è§¦å‘æ¡ä»¶æ»¡è¶³æ—¶ï¼Œå°†ä¼šæ‰§è¡Œ `BEGIN` å’Œ `END` ä¹‹é—´çš„è§¦å‘å™¨æ‰§è¡ŒåŠ¨ä½œã€‚

> ğŸ”” æ³¨æ„ï¼šåœ¨ MySQL ä¸­ï¼Œåˆ†å· `;` æ˜¯è¯­å¥ç»“æŸçš„æ ‡è¯†ç¬¦ï¼Œé‡åˆ°åˆ†å·è¡¨ç¤ºè¯¥æ®µè¯­å¥å·²ç»ç»“æŸï¼ŒMySQL å¯ä»¥å¼€å§‹æ‰§è¡Œäº†ã€‚å› æ­¤ï¼Œè§£é‡Šå™¨é‡åˆ°è§¦å‘å™¨æ‰§è¡ŒåŠ¨ä½œä¸­çš„åˆ†å·åå°±å¼€å§‹æ‰§è¡Œï¼Œç„¶åä¼šæŠ¥é”™ï¼Œå› ä¸ºæ²¡æœ‰æ‰¾åˆ°å’Œ BEGIN åŒ¹é…çš„ ENDã€‚
>
> è¿™æ—¶å°±ä¼šç”¨åˆ° `DELIMITER` å‘½ä»¤ï¼ˆ`DELIMITER` æ˜¯å®šç•Œç¬¦ï¼Œåˆ†éš”ç¬¦çš„æ„æ€ï¼‰ã€‚å®ƒæ˜¯ä¸€æ¡å‘½ä»¤ï¼Œä¸éœ€è¦è¯­å¥ç»“æŸæ ‡è¯†ï¼Œè¯­æ³•ä¸ºï¼š`DELIMITER new_delemiter`ã€‚`new_delemiter` å¯ä»¥è®¾ä¸º 1 ä¸ªæˆ–å¤šä¸ªé•¿åº¦çš„ç¬¦å·ï¼Œé»˜è®¤çš„æ˜¯åˆ†å· `;`ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒä¿®æ”¹ä¸ºå…¶ä»–ç¬¦å·ï¼Œå¦‚ `$` - `DELIMITER $` ã€‚åœ¨è¿™ä¹‹åçš„è¯­å¥ï¼Œä»¥åˆ†å·ç»“æŸï¼Œè§£é‡Šå™¨ä¸ä¼šæœ‰ä»€ä¹ˆååº”ï¼Œåªæœ‰é‡åˆ°äº† `$`ï¼Œæ‰è®¤ä¸ºæ˜¯è¯­å¥ç»“æŸã€‚æ³¨æ„ï¼Œä½¿ç”¨å®Œä¹‹åï¼Œæˆ‘ä»¬è¿˜åº”è¯¥è®°å¾—æŠŠå®ƒç»™ä¿®æ”¹å›æ¥ã€‚

**`NEW` å’Œ `OLD`**

- MySQL ä¸­å®šä¹‰äº† `NEW` å’Œ `OLD` å…³é”®å­—ï¼Œç”¨æ¥è¡¨ç¤ºè§¦å‘å™¨çš„æ‰€åœ¨è¡¨ä¸­ï¼Œè§¦å‘äº†è§¦å‘å™¨çš„é‚£ä¸€è¡Œæ•°æ®ã€‚
- åœ¨ `INSERT` å‹è§¦å‘å™¨ä¸­ï¼Œ`NEW` ç”¨æ¥è¡¨ç¤ºå°†è¦ï¼ˆ`BEFORE`ï¼‰æˆ–å·²ç»ï¼ˆ`AFTER`ï¼‰æ’å…¥çš„æ–°æ•°æ®ï¼›
- åœ¨ `UPDATE` å‹è§¦å‘å™¨ä¸­ï¼Œ`OLD` ç”¨æ¥è¡¨ç¤ºå°†è¦æˆ–å·²ç»è¢«ä¿®æ”¹çš„åŸæ•°æ®ï¼Œ`NEW` ç”¨æ¥è¡¨ç¤ºå°†è¦æˆ–å·²ç»ä¿®æ”¹ä¸ºçš„æ–°æ•°æ®ï¼›
- åœ¨ `DELETE` å‹è§¦å‘å™¨ä¸­ï¼Œ`OLD` ç”¨æ¥è¡¨ç¤ºå°†è¦æˆ–å·²ç»è¢«åˆ é™¤çš„åŸæ•°æ®ï¼›
- ä½¿ç”¨æ–¹æ³•ï¼š `NEW.columnName` ï¼ˆcolumnName ä¸ºç›¸åº”æ•°æ®è¡¨æŸä¸€åˆ—åï¼‰

#### è§¦å‘å™¨æŒ‡ä»¤

> æç¤ºï¼šä¸ºäº†ç†è§£è§¦å‘å™¨çš„è¦ç‚¹ï¼Œæœ‰å¿…è¦å…ˆäº†è§£ä¸€ä¸‹åˆ›å»ºè§¦å‘å™¨çš„æŒ‡ä»¤ã€‚

`CREATE TRIGGER` æŒ‡ä»¤ç”¨äºåˆ›å»ºè§¦å‘å™¨ã€‚

è¯­æ³•ï¼š

```sql
CREATE TRIGGER trigger_name
trigger_time
trigger_event
ON table_name
FOR EACH ROW
BEGIN
  trigger_statements
END;
```

è¯´æ˜ï¼š

- trigger_nameï¼šè§¦å‘å™¨å
- trigger_time: è§¦å‘å™¨çš„è§¦å‘æ—¶æœºã€‚å–å€¼ä¸º `BEFORE` æˆ– `AFTER`ã€‚
- trigger_event: è§¦å‘å™¨çš„ç›‘å¬äº‹ä»¶ã€‚å–å€¼ä¸º `INSERT`ã€`UPDATE` æˆ– `DELETE`ã€‚
- table_name: è§¦å‘å™¨çš„ç›‘å¬ç›®æ ‡ã€‚æŒ‡å®šåœ¨å“ªå¼ è¡¨ä¸Šå»ºç«‹è§¦å‘å™¨ã€‚
- FOR EACH ROW: è¡Œçº§ç›‘è§†ï¼ŒMysql å›ºå®šå†™æ³•ï¼Œå…¶ä»– DBMS ä¸åŒã€‚
- trigger_statements: è§¦å‘å™¨æ‰§è¡ŒåŠ¨ä½œã€‚æ˜¯ä¸€æ¡æˆ–å¤šæ¡ SQL è¯­å¥çš„åˆ—è¡¨ï¼Œåˆ—è¡¨å†…çš„æ¯æ¡è¯­å¥éƒ½å¿…é¡»ç”¨åˆ†å· `;` æ¥ç»“å°¾ã€‚

åˆ›å»ºè§¦å‘å™¨ç¤ºä¾‹ï¼š

```sql
DELIMITER $
CREATE TRIGGER `trigger_insert_user`
AFTER INSERT ON `user`
FOR EACH ROW
BEGIN
    INSERT INTO `user_history`(user_id, operate_type, operate_time)
    VALUES (NEW.id, 'add a user',  now());
END $
DELIMITER ;
```

æŸ¥çœ‹è§¦å‘å™¨ç¤ºä¾‹ï¼š

```sql
SHOW TRIGGERS;
```

åˆ é™¤è§¦å‘å™¨ç¤ºä¾‹ï¼š

```sql
DROP TRIGGER IF EXISTS trigger_insert_user;
```

## æ¸¸æ ‡

> æ¸¸æ ‡ï¼ˆCURSORï¼‰æ˜¯ä¸€ä¸ªå­˜å‚¨åœ¨ DBMS æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“æŸ¥è¯¢ï¼Œå®ƒä¸æ˜¯ä¸€æ¡ `SELECT` è¯­å¥ï¼Œè€Œæ˜¯è¢«è¯¥è¯­å¥æ£€ç´¢å‡ºæ¥çš„ç»“æœé›†ã€‚åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ä½¿ç”¨æ¸¸æ ‡å¯ä»¥å¯¹ä¸€ä¸ªç»“æœé›†è¿›è¡Œç§»åŠ¨éå†ã€‚

æ¸¸æ ‡ä¸»è¦ç”¨äºäº¤äº’å¼åº”ç”¨ï¼Œå…¶ä¸­ç”¨æˆ·éœ€è¦å¯¹æ•°æ®é›†ä¸­çš„ä»»æ„è¡Œè¿›è¡Œæµè§ˆå’Œä¿®æ”¹ã€‚

ä½¿ç”¨æ¸¸æ ‡çš„æ­¥éª¤ï¼š

1. **å®šä¹‰æ¸¸æ ‡**ï¼šé€šè¿‡ `DECLARE cursor_name CURSOR FOR <è¯­å¥>` å®šä¹‰æ¸¸æ ‡ã€‚è¿™ä¸ªè¿‡ç¨‹æ²¡æœ‰å®é™…æ£€ç´¢å‡ºæ•°æ®ã€‚
2. **æ‰“å¼€æ¸¸æ ‡**ï¼šé€šè¿‡ `OPEN cursor_name` æ‰“å¼€æ¸¸æ ‡ã€‚
3. **å–å‡ºæ•°æ®**ï¼šé€šè¿‡ `FETCH cursor_name INTO var_name ...` è·å–æ•°æ®ã€‚
4. **å…³é—­æ¸¸æ ‡**ï¼šé€šè¿‡ `CLOSE cursor_name` å…³é—­æ¸¸æ ‡ã€‚
5. **é‡Šæ”¾æ¸¸æ ‡**ï¼šé€šè¿‡ `DEALLOCATE PREPARE` é‡Šæ”¾æ¸¸æ ‡ã€‚

æ¸¸æ ‡ä½¿ç”¨ç¤ºä¾‹ï¼š

```sql
DELIMITER $
CREATE PROCEDURE getTotal()
BEGIN
    DECLARE total INT;
    -- åˆ›å»ºæ¥æ”¶æ¸¸æ ‡æ•°æ®çš„å˜é‡
    DECLARE sid INT;
    DECLARE sname VARCHAR(10);
    -- åˆ›å»ºæ€»æ•°å˜é‡
    DECLARE sage INT;
    -- åˆ›å»ºç»“æŸæ ‡å¿—å˜é‡
    DECLARE done INT DEFAULT false;
    -- åˆ›å»ºæ¸¸æ ‡
    DECLARE cur CURSOR FOR SELECT id,name,age from cursor_table where age>30;
    -- æŒ‡å®šæ¸¸æ ‡å¾ªç¯ç»“æŸæ—¶çš„è¿”å›å€¼
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = true;
    SET total = 0;
    OPEN cur;
    FETCH cur INTO sid, sname, sage;
    WHILE(NOT done)
    DO
        SET total = total + 1;
        FETCH cur INTO sid, sname, sage;
    END WHILE;

    CLOSE cur;
    SELECT total;
END $
DELIMITER ;

-- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
call getTotal();
```

## å‚è€ƒèµ„æ–™

- [ã€ŠSQL å¿…çŸ¥å¿…ä¼šã€‹](https://book.douban.com/subject/35167240/)
- [ã€æµ…å…¥æ·±å‡ºã€MySQL ä¸­äº‹åŠ¡çš„å®ç°](https://draveness.me/mysql-transaction)
- [MySQL çš„å­¦ä¹ --è§¦å‘å™¨](https://www.cnblogs.com/CraryPrimitiveMan/p/4206942.html)
- [ç»´åŸºç™¾ç§‘è¯æ¡ - SQL](https://zh.wikipedia.org/wiki/SQL)
- [https://www.sitesbay.com/sql/index](https://www.sitesbay.com/sql/index)
- [SQL Subqueries](https://www.w3resource.com/sql/subqueries/understanding-sql-subqueries.php)
- [Quick breakdown of the types of joins](https://stackoverflow.com/questions/6294778/mysql-quick-breakdown-of-the-types-of-joins)
- [SQL UNION](https://www.w3resource.com/sql/sql-union.php)
- [SQL database security](https://www.w3resource.com/sql/database-security/create-users.php)
- [Mysql ä¸­çš„å­˜å‚¨è¿‡ç¨‹](https://www.cnblogs.com/chenpi/p/5136483.html)